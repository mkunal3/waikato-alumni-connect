# Waikato Alumni Connect Backend - AI Agent Guidelines

## Project Overview

**Backend** is a TypeScript + Express.js REST API for the Waikato Alumni Connect mentoring platform (port 4000). It manages user registration, authentication, and approval workflows using Prisma ORM with PostgreSQL.

---

## Stack & Key Dependencies

- **Express.js** - HTTP server framework
- **Prisma Client** - TypeScript ORM for PostgreSQL
- **bcryptjs** - Password hashing (10 salt rounds standard)
- **TypeScript** - Type safety across codebase
- **ts-node-dev** - Development server with auto-restart

---

## Architecture

### Directory Structure
```
backend/
├── src/
│   ├── index.ts           # Express app setup, root routes
│   ├── prisma.ts          # Prisma singleton export
│   └── auth/
│       └── register.ts    # User registration route
├── prisma/
│   ├── schema.prisma      # Data model (DO NOT manually edit migrations)
│   └── migrations/        # Auto-generated by Prisma
├── tsconfig.json          # TypeScript config
└── package.json
```

### Database Model (Prisma)
Key table: **User**
- `id` (Int, auto-increment PK)
- `name`, `email` (String, email unique)
- `role` (String) — values: "student", "alumni", "admin"
- `passwordHash` (String) — bcrypt hashed
- `approvalStatus` (String, default "pending") — values: "pending", "approved", "rejected"
- `createdAt` (DateTime, auto-set)

**Critical**: New users always have `approvalStatus: "pending"`. Admins must approve before users gain full access.

---

## Core Patterns

### 1. Prisma Client Usage
```typescript
// ✅ CORRECT: Reuse singleton
import prisma from "./prisma";

app.get("/users", async (_req, res) => {
  try {
    const users = await prisma.user.findMany();
    res.json(users);
  } catch (error) {
    console.error("Error fetching users:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});
```

**Rule**: Always import from `./prisma`, never instantiate `new PrismaClient()` in routes.

### 2. Authentication - Password Hashing
```typescript
import bcrypt from "bcryptjs";

// Hash on registration
const passwordHash = await bcrypt.hash(password, 10);

// Verify on login (not yet implemented)
const isValid = await bcrypt.compare(plainPassword, storedHash);
```

### 3. Route Organization
- Group related endpoints in feature folders (`auth/`, `mentors/`, `students/`, etc.)
- Export as Router, mount in `index.ts`
- Always include try/catch and error responses

```typescript
// In src/features/register.ts
export default router;

// In src/index.ts
import registerRoute from "./auth/register";
app.use("/auth", registerRoute);
```

### 4. Error Responses
Consistent JSON format:
```typescript
res.status(400).json({ error: "User already exists" });
res.status(500).json({ error: "Internal server error" });
```

Success responses:
```typescript
res.json({ message: "...", userId: X });
```

---

## Development Workflow

### Setup & Commands
```bash
# Install dependencies
npm install

# Dev server (auto-restart on changes)
npm run dev

# Build TypeScript
npm build

# Start production build
npm start
```

### Database Migrations
After modifying `prisma/schema.prisma`:
```bash
# Create & apply migration
npx prisma migrate dev --name <description>

# View database GUI
npx prisma studio

# Reset database (development only)
npx prisma migrate reset
```

**Never** manually edit files in `prisma/migrations/` — Prisma auto-generates them.

---

## Adding New Features

### Checklist for New Route
1. ✅ Create file in `src/<feature>/<action>.ts`
2. ✅ Define Router and export it
3. ✅ Import Prisma singleton
4. ✅ Wrap logic in try/catch
5. ✅ Return consistent JSON responses
6. ✅ Import route in `src/index.ts` and mount with `app.use()`
7. ✅ Test with cURL or Postman

### Checklist for Schema Changes
1. ✅ Update `prisma/schema.prisma` model
2. ✅ Run `npx prisma migrate dev --name <description>`
3. ✅ Commit both schema and migration files
4. ✅ Update routes to use new fields

---

## Current API Endpoints

| Method | Path | Status | Purpose |
|--------|------|--------|---------|
| GET | `/` | ✅ | Health check |
| GET | `/users` | ✅ | Fetch all users (temp) |
| POST | `/auth/register` | ✅ | Register new user |

---

## Type Safety & Conventions

- **Always use TypeScript types** — avoid `any`
- **Validate input**: Check required fields before DB operations
- **Error logging**: Use `console.error()` with context
- **Async/await**: Prefer over `.then()` chains

---

## Testing Tips

```bash
# Register user
curl -X POST http://localhost:4000/auth/register \
  -H "Content-Type: application/json" \
  -d '{"name":"Test","email":"test@example.com","password":"pass123","role":"student"}'

# Fetch users
curl http://localhost:4000/users

# View DB
npx prisma studio
```

---

## When Extending

- **New roles?** Update User.role enum in schema, create role-specific routes
- **New tables?** Create model in schema, migrate, update Prisma client imports
- **Auth flows?** Consider session/JWT later; currently register-only
- **Validation?** Add before Prisma calls, not after
